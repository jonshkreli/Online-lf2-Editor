<!--suppress JSDuplicatedDeclaration -->
<html>
<head>
    <title>LF edior</title>
</head>
<style type="text/css">
    #big-sprite{
        height: auto;
        width: auto;
    }
    .pic{width: 79px; height: 79px;}
    lfframe{width: 90%; margin: 10px auto; padding: 5px; display: block;}
    lfframe:nth-child(even){background: #cac7c8;}
    lfframe:nth-child(odd){background: #e6e6e6;}
    lfframe p, .frame .pic{
        display: inline-block;
    }
    .frameIDDiv {
        display: inline-block;
        background: red;
        font-size: xx-large;
    }
    .frameNameDiv {
        display: inline-block;
    }
    jumpbut {
        display: inline-block;
        background: #3939d2;
        color: white;
        border-radius: 2px;
    }
    .next{ color: #000;}
    .frameIDDiv, .frameNameDiv, jumpbut{ margin: 1px;  padding: 2px;  }


</style>
<script type="text/javascript">
    var file;
    var text = "";

    var characters=[];


    function fileSupport() {// Check for the various File API support.
        if (window.File && window.FileReader && window.FileList && window.Blob) {
            // Great success! All the File APIs are supported.
            console.log('sucess')
        } else {
            alert('The File APIs are not fully supported in this browser.');
            console.log('The File APIs are not fully supported in this browser')
        }
    }

    function openFile() {
        file = document.getElementById("fileInput").files[0];
        var fileName = escape(file.name);
        var fileType = (file.type ? file.type : 'n/a');
        var fileSize = file.size;
        var lastModified = file.lastModifiedDate ? file.lastModifiedDate.toLocaleDateString() : 'n/a';

        if(file.name.substring(file.name.lastIndexOf(".")) != ".dat" ) {
            alert('LF2 data file only.');
            return false;
        }
        else {
            fileType = "LF2/data";
        }
        document.getElementById('details').innerHTML =
                '<strong>' + fileName + '</strong> (' + fileType + ') - ' +
                fileSize + ' bytes, last modified: ' + lastModified;
        return true;
    }






    function decrypt() {
        var key = "odBearBecauseHeIsVeryGoodSiuHungIsAGo";
        var reader = new FileReader();

        reader.onload = function(){
            var data = reader.result;
            
            for (var i = 123, j = 0; i < data.length; i++, j++)
                text += String.fromCharCode(data.charCodeAt(i) - key.charCodeAt(j%key.length));

            /*Plain text code in a textarea*/
            document.getElementById('DCode').innerHTML = text;

            /*Variables to be fetched from character*/
            var frames=[];
            var files;
            var character ={};
            var bmpKeys = ['name','head','small'];
            var frameHeaderKeys=['pic','state','dvx','dvy','centerx','centery'];

            var ExtractedText="";
            /*function to grab value in bmp part
            * Parameters What to grab(string),Where (string) [Datatype 'number'(default)|'string'|'twonumbers',
            * colon boolean (is : or not, default true)]*/
            function grabValue(catchThis,InHere,DataType,colon) {
               // console.log('3param =>')
               // console.log(catchThis+InHere+DataType);
               // console.log('}}}}}}}}')
                if(DataType===undefined) { DataType='number';}
                else {/* console.log('def '+DataType);*/ }
                if(colon===undefined) { colon = true;}
                if(colon){
                var regex = new RegExp("\\s+"+catchThis+"\\s*:\\s*\\w*\\.?\\w+",'gm');}
                /*This create a regex such as ' row: 14fr43r0' or '      row: 1.500000'*/
                //console.log(regex);
                //console.log(InHere);
                var storePlace= InHere.toString().match(regex);
                //console.log(storePlace)
                if(storePlace){
                    //console.log('sp0' +storePlace+ '/sp0');
                    if(DataType=='number'){
                        storePlace = storePlace[0].match(/\d+/);
                        /*This grab number such as ' 34 ' or ' -45.34565 '*/

                        if(storePlace){ storePlace =  storePlace[0].trim(); }
                        else console.log("There is no value for "+catchThis+" as a number");
                    }

                    else if(DataType=='string') {
                       // console.log(DataType);
                        storePlace = storePlace[0].match(/(\w+)(\.?)(\w*)/g);
                       // console.log('sp1' +storePlace+ '/sp1');
                        /*grab the second word ex: name: mycharacter*/
                        if(storePlace){ storePlace = storePlace[1]; /*console.log('sp2' +storePlace+ '/sp2');*/}
                        else console.log("There is no value for "+catchThis);

                    }


                }
                return storePlace;
            }

            /*Function to fetch sprites*/
            var bigsp;
            var spSize = [-79,-79];
            var size = [10,8];
            function ShowSprites(path,PrevPics,row,col,w,h) {
                var poz = [0,0];
                var errors = [];
                if(path===undefined){console.log("Path is not defined"); errors.push( 'Path is not defined');}
                else {
                    if (PrevPics === undefined) PrevPics=0;
                    if (w === undefined) w = spSize[0];
                    if (h === undefined) h = spSize[1];
                    if (row === undefined) row = size[1];
                    if (col === undefined) col = size[0];



                    var spriteName = path.match(/[^\\]+\.(bmp|png)/);
                    if (spriteName) {spriteName = spriteName[0];}
                    else {errors.push('Sprite not given properly (Maybe sprite name length is 0)');}

                    bigsp = document.getElementById("picTemplate");
                    /*The first is exec size[0] which is 10*/
                    if(errors.length==0)
                        for (i = 0; i < row; i++) {
                            for (j = 0; j < col; j++) {
                                var pic = document.createElement("DIV");
                                pic.className = 'pic';
                                pic.id = character['name'] + '-' + (i * 10 + j + PrevPics);
                                pic.style.background = 'url("'+path+'") ' + w * j + 'px ' + h * i + 'px';
                                pic.draggable = true;
                                bigsp.appendChild(pic);

                            }
                        }
                }
                return errors;
            }

            ExtractedText = text.split('<frame>'); /*Get text from each frame*/
            /*chack if bmp part is ok*/
            if(ExtractedText[0].search(/<\s*bmp_begin\s*>/)!=-1 && ExtractedText[0].search(/<\s*bmp_end\s*>/)!=-1){
                console.log('OK');
            } else {console.log('There is something wrong with "<bmp_begin>"or "<bmp_end>"')}
            
            /*continue anyway*/
            //console.log(frame.txt[0]);
            for(key in bmpKeys) {
                //console.log(bmpKeys[key], frames.txt[0],'string')
                character[bmpKeys[key]] = grabValue(bmpKeys[key], ExtractedText[0],'string');
            }
            


            var filesString = ExtractedText[0].match(/file(\(.*\))*:\s*.+/g);
            if(filesString){
                 files = new Array(filesString.length);
                /*grab path and w,h,row,col*/
                for(f=0;f<filesString.length;f++){
                    files[f] = {};
                    if(filesString[f].match(/(\S)+\.(bmp|\.png)/)) {
                        files[f].path =  filesString[f].match(/(\S)+\.(bmp|\.png)/)[0];
                    }
                    files[f].w = grabValue('w',filesString[f]);
                    files[f].h = grabValue('h',filesString[f]);
                    files[f].row = grabValue('row',filesString[f]);
                    files[f].col = grabValue('col',filesString[f]);


                    var res=ShowSprites(files[f].path,(f*files[f].row*files[f].col));
                    if(res.length>0)
                    console.log(res);
                }
            }

            /*create character container div*/
            var CharContainer = document.createElement("DIV");
            CharContainer.className = 'charContainer';
            CharContainer.id ='cc-'+character.name;
            document.getElementById('main').appendChild(CharContainer);

            /*create elements for frame div for pic and p for text*/
            for(i=1;i<ExtractedText.length;i++){ /*i=0 is bmp part*/

                var lfframeDOM = document.createElement("lfframe");
                var para = document.createElement("P");
                lfframeDOM.className = 'frame';
                para.contentEditable = 'true';

                var frame={}; /*variable which will hold all frame properties*/

                /*first get frame number and name*/
                var FrameNum = ExtractedText[i].match(/\d+/);
                if(FrameNum) frame['ID'] = FrameNum[0];
                else {console.log("FATAL ERROR FRAME IS MISSING ID. \n Look on: "+ExtractedText[i])}

                var FrameName = ExtractedText[i].match(/\S+\w/);
                if(FrameName) frame['Name'] = FrameName[0];
                else {console.log("FATAL ERROR FRAME IS MISSING ID. \n Look on: "+ExtractedText[i])}

                /*get all elements from header*/
                for(key in frameHeaderKeys) {
                    //console.log(bmpKeys[key], frames.txt[0],'string')
                    frame[frameHeaderKeys[key]] = grabValue(frameHeaderKeys[key], ExtractedText[i]);
                }
                //console.log('['+frame['pic']+']');


                    var shownpic = document.getElementById(character['name']+'-'+frame['pic']);
                    //console.log(shownpic);
                if(shownpic) {
                    var ClonePic = document.createElement("DIV");
                    ClonePic.style.background = shownpic.style.background;
                    ClonePic.className = 'pic';
                    ClonePic.id = shownpic.id+"-pic";
                    ClonePic.draggable = shownpic.draggable;
                    lfframeDOM.appendChild(ClonePic); } /*append image in frame*/

                /*Now assign frame id and add a class for each frame name*/
                lfframeDOM.id = character.name+'-'+frame.ID;
                lfframeDOM.className+= ' ' + frame.Name;
                /*Create divs for frame number and name and also all header elements*/
                var FrameIDDiv = document.createElement('DIV');
                FrameIDDiv.className = 'frameIDDiv';
                FrameIDDiv.contentEditable = true;
                FrameIDDiv.innerText = frame.ID;
                var FrameNameDiv= document.createElement('DIV');
                FrameNameDiv.className = 'frameNameDiv';
                FrameNameDiv.contentEditable = true;
                FrameNameDiv.innerText = frame.Name;
                lfframeDOM.appendChild(FrameIDDiv);  lfframeDOM.appendChild(FrameNameDiv);

                var patternJump = /(next:\s*\d+)|(hit_Fa:\s*\d+)|(hit_Da:\s*\d+)|(hit_Ua:\s*\d+)|(hit_Fj:\s*\d+)|(hit_Dj:\s*\d+)|(hit_Uj:\s*\d+)|(hit_ja:\s*\d+)/g;
                var JumpFrames = ExtractedText[i].match(patternJump);
                /*if there are jump frames add divs with them*/
                if(JumpFrames){
                    for(k=0;k< JumpFrames.length;k++){
                        //console.log(JumpFrames[k]);
                        var JumpBut = document.createElement("JUMPBUT");
                        if(JumpFrames[k].match('next:'))
                            JumpBut.className=JumpFrames[k].match('next')[0];
                        JumpBut.innerText = JumpFrames[k];
                        JumpBut.contentEditable = 'true';
                        lfframeDOM.appendChild(JumpBut);
                    }

                }




                para.innerText =ExtractedText[i];/*append text in paragraph*/
                lfframeDOM.appendChild(para); /*appen paragraph in frame*/
                CharContainer.appendChild(lfframeDOM);

                frames.push(frame);

            }

            /*Now after clonning all pics to their postiotions delete the raw form of them*/
            var myNode = document.getElementById("picTemplate");
            while (myNode.firstChild) {
                myNode.removeChild(myNode.firstChild);
            }
            character.files=files;
            character.frames = frames;
           // console.log(character);

            /*Now attach events to DOM elements*/
            var jumpbuts= document.getElementsByTagName('jumpbut');
            for(jb =0;jb< jumpbuts.length;jb++) {
                //console.log('jb')
                //console.log(jumpbuts[jb])
               // console.log(jumpbuts[jb].innerText)
               // console.log(jumpbuts[jb].innerText.match(/\d+/))
               // console.log(jumpbuts[jb].innerText.match(/\d+/)[0])
                var jumpNum= jumpbuts[jb].innerText.match(/\d+/)[0];
                console.log(jumpNum);
                jumpbuts[jb].addEventListener('mousedown', function (e) {
                    /*On shift+click jumpt to frame number*/
                    if(e.shiftKey){
                        console.log(jumpNum);
                       document.getElementById(character.name+ '-' + jumpNum).focus();
                    }
                })
            }
            characters.push(character)
        };


        reader.readAsBinaryString(file);
    }




</script>
<body onload="fileSupport();">

<div id="main" >
    <label for="fileInput">Open .dat file:</label>
    <br>
    <input id="fileInput" type="file" onchange="if(openFile()) decrypt();">
    <br>
    <output id="details"></output>
    <br>
    <textarea id="DCode" wrap='off'></textarea>
</div>

<div id="picTemplate" class="pic">

</div>
<frame> 2 standing
pic: 25 state: 0  wait: 3  next: 3  dvx: 0  dvy: 0  dvz: 0  centerx: 38  centery: 79  hit_a: 0  hit_d: 0  hit_j: 0 hit_Fa: 235 hit_Ua: 247 hit_Da: 254 hit_Fj: 0 hit_Uj: 0
bpoint:
x: 39  y: 34
bpoint_end:
wpoint:
kind: 1  x: 19  y: 55  weaponact: 23  attacking: 0  cover: 0  dvx: 0  dvy: 0  dvz: 0
wpoint_end:
bdy:
kind: 0  x: 18  y: 18  w: 40  h: 60
bdy_end:
<frame_end>

    <frame> 3 standing
    pic:   3  state: 0  wait: 10  next: 4  dvx: 0  dvy: 0  dvz: 0  centerx: 38  centery: 79  hit_a: 0  hit_d: 0  hit_j: 0 hit_Fa: 235  hit_Ua: 247 hit_Da: 254 hit_Fj: 0 hit_Uj: 0
    bpoint:
    x: 39  y: 34
    bpoint_end:
    wpoint:
    kind: 1 x: 18  y: 55  weaponact: 23  attacking: 0  cover: 0  dvx: 0  dvy: 0  dvz: 0
    wpoint_end:
    bdy:
    kind: 0  x: 18  y: 18  w: 40  h: 60
    bdy_end:
    <frame_end>

</body>
</html>